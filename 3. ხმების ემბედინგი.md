# XTTS-v2 ხმოვანი ემბედინგების გენერირება

ეს დოკუმენტი წარმოადგენს ხმოვანი ემბედინგების გენერირების მე-3 ეტაპის დეტალურ გზამკვლევს XTTS-v2 მოდელის ქართული ენისთვის დატრეინინგების პროცესში.

## შესავალი

ხმოვანი ემბედინგები არის ვექტორული რეპრეზენტაციები, რომლებიც წარმოადგენენ სპიკერის ხმის უნიკალურ მახასიათებლებს. XTTS-v2 იყენებს ამ ემბედინგებს რათა შეძლოს ტექსტიდან კონკრეტული სპიკერის ხმის იმიტირება. ეს ეტაპი კრიტიკულად მნიშვნელოვანია ხმის სინთეზის ხარისხისთვის.

## ფაილების სტრუქტურა

პროექტში ხმოვანი ემბედინგების ეტაპი შედგება შემდეგი ფაილებისგან:

```
xtts2_training/
├── voice_embedding.py          # ხმოვანი ემბედინგების ძირითადი კლასი
├── embedding_visualization.py  # ემბედინგების ვიზუალიზაციის ფუნქციონალი
├── prepare_embeddings.py       # ემბედინგების მომზადების მთავარი ლოგიკა
├── generate_embeddings.py      # გასაშვები სკრიპტი ემბედინგების შესაქმნელად
└── data/                       # მონაცემების დირექტორია
    ├── segmented/              # სეგმენტირებული აუდიო ფაილები
    ├── embeddings/             # ემბედინგების შედეგები
    │   ├── embeddings/         # .npy ფაილები
    │   └── visualizations/     # ვიზუალიზაციები
    └── split/                  # დაყოფილი მონაცემები
```

## ფაილების დეტალური აღწერა

### 1. voice_embedding.py

ეს ფაილი შეიცავს `VoiceEmbeddingGenerator` კლასს, რომელიც ახორციელებს ხმოვანი ემბედინგების გენერირების ძირითად ლოგიკას:

- **მოდელის ჩატვირთვა**: იყენებს WavLM მოდელს Microsoft-დან
- **აუდიოს წინასწარი დამუშავება**: აუდიო ფაილების ნორმალიზაციას და resampling-ს
- **ემბედინგების გამოთვლა**: აუდიო მონაცემებიდან ვექტორების შექმნა
- **გრძელი აუდიო ფაილების დამუშავება**: ასევე ახორციელებს სეგმენტირებას და ემბედინგების გასაშუალოებას

#### ძირითადი ფუნქციები:

- `__init__`: მოდელის ინიციალიზაცია
- `preprocess_audio`: აუდიო ფაილების წინასწარი დამუშავება
- `compute_embedding`: ემბედინგების გამოთვლა
- `generate_embedding_from_file`: ემბედინგების გენერირება ფაილიდან
- `process_long_audio`: გრძელი აუდიოს დამუშავება სეგმენტებად
- `generate_embeddings_batch`: მრავალი ფაილის ერთდროული დამუშავება

### 2. embedding_visualization.py

ეს ფაილი შეიცავს `EmbeddingVisualizer` კლასს, რომელიც ახორციელებს ემბედინგების ვიზუალიზაციას:

- **განზომილების შემცირება**: t-SNE და UMAP ალგორითმების გამოყენება
- **ვიზუალიზაცია**: სხვადასხვა ტიპის გრაფიკები და დიაგრამები
- **ინტერაქტიული ვიზუალიზაცია**: Plotly-ს მეშვეობით

#### ძირითადი ფუნქციები:

- `load_embeddings`: ემბედინგების ჩატვირთვა
- `apply_tsne`: t-SNE ალგორითმის გამოყენება
- `apply_umap`: UMAP ალგორითმის გამოყენება
- `visualize_embeddings`: ვიზუალიზაციის შექმნა
- `visualize_embeddings_interactive`: ინტერაქტიული ვიზუალიზაციის შექმნა

### 3. prepare_embeddings.py

ეს ფაილი ახორციელებს ხმოვანი ემბედინგების მომზადების მთლიან პროცესს:

- **ემბედინგების გენერირება**: `VoiceEmbeddingGenerator`-ის გამოყენებით
- **ვიზუალიზაცია**: `EmbeddingVisualizer`-ის გამოყენებით
- **მეტადატას განახლება**: ემბედინგების გზების დამატება
- **XTTS კონფიგურაციის განახლება**: ემბედინგების ინფორმაციის დამატება

#### ძირითადი ფუნქციები:

- `prepare_embeddings`: მთავარი ფუნქცია ემბედინგების მოსამზადებლად
- `update_xtts_config`: XTTS კონფიგურაციის განახლება
- `copy_embeddings_to_split_folders`: ემბედინგების კოპირება split დირექტორიებში

### 4. generate_embeddings.py

ეს ფაილი წარმოადგენს მარტივ გასაშვებ სკრიპტს, რომელიც იძახებს `prepare_embeddings.py`-ს ფუნქციონალს:

- **არგუმენტების დამუშავება**: კომანდის სტრიქონის არგუმენტების პარსინგი
- **ემბედინგების გენერირება**: სეგმენტირებული ფაილებიდან
- **შედეგების ლოგირება**: პროცესის მიმდინარეობის ჩვენება

#### ძირითადი ფუნქციები:

- `main`: სკრიპტის მთავარი ფუნქცია

## გაშვების ინსტრუქცია

### წინაპირობები

ხმოვანი ემბედინგების გენერირებისთვის საჭიროა შემდეგი ბიბლიოთეკების დაინსტალირება:

```bash
# ძირითადი ბიბლიოთეკები
pip install transformers datasets soundfile librosa torch pandas tqdm

# ვიზუალიზაციისთვის
pip install scikit-learn matplotlib seaborn

# დამატებითი ვიზუალიზაციისთვის (არასავალდებულო)
pip install umap-learn plotly
```

### ძირითადი გაშვება

ყველაზე მარტივი გზაა `generate_embeddings.py` სკრიპტის გაშვება:

```bash
python generate_embeddings.py --segmented_dir data/segmented --output_dir data/embeddings
```

ეს ბრძანება:
1. ჩატვირთავს WavLM მოდელს
2. დაამუშავებს სეგმენტირებულ აუდიო ფაილებს `data/segmented` დირექტორიიდან
3. შექმნის ემბედინგებს და შეინახავს `data/embeddings/embeddings` დირექტორიაში
4. შექმნის ვიზუალიზაციებს და შეინახავს `data/embeddings/visualizations` დირექტორიაში
5. შექმნის ან განაახლებს XTTS კონფიგურაციის ფაილს

### პარამეტრები

#### ძირითადი პარამეტრები

| პარამეტრი | აღწერა | ნაგულისხმევი მნიშვნელობა |
|-----------|--------|---------------------------|
| `--segmented_dir` | სეგმენტირებული აუდიოს დირექტორია | `data/segmented` |
| `--output_dir` | შედეგების დირექტორია | `data/embeddings` |
| `--metadata` | მეტადატას ფაილი | `data/metadata.csv` |

#### WavLM მოდელის პარამეტრები

| პარამეტრი | აღწერა | ნაგულისხმევი მნიშვნელობა |
|-----------|--------|---------------------------|
| `--model` | WavLM მოდელის სახელი | `microsoft/wavlm-base-plus` |
| `--device` | გამოსაყენებელი მოწყობილობა | `None` (ავტომატური) |

#### ემბედინგის პარამეტრები

| პარამეტრი | აღწერა | ნაგულისხმევი მნიშვნელობა |
|-----------|--------|---------------------------|
| `--segment_length` | სეგმენტის სიგრძე წამებში | `5.0` |
| `--segment_overlap` | სეგმენტების გადაფარვა წამებში | `1.0` |

#### დამატებითი პარამეტრები

| პარამეტრი | აღწერა | ნაგულისხმევი მნიშვნელობა |
|-----------|--------|---------------------------|
| `--no_visualize` | ვიზუალიზაციის გამორთვა | `False` |
| `--overwrite` | არსებული ემბედინგების გადაწერა | `False` |
| `--copy_to_split` | ემბედინგების კოპირება split საქაღალდეში | `None` |

### გაშვების მაგალითები

#### ძირითადი გაშვება
```bash
python generate_embeddings.py --segmented_dir data/segmented --output_dir data/embeddings
```

#### GPU-ზე გაშვება
```bash
python generate_embeddings.py --device cuda
```

#### უკეთესი ხარისხის ემბედინგები (უფრო დიდი მოდელი)
```bash
python generate_embeddings.py --model microsoft/wavlm-large
```

#### ემბედინგები გრძელი სეგმენტებით
```bash
python generate_embeddings.py --segment_length 10.0 --segment_overlap 2.0
```

#### ემბედინგების კოპირება split საქაღალდეში
```bash
python generate_embeddings.py --copy_to_split data/split
```

#### ვიზუალიზაციის გარეშე (უფრო სწრაფი)
```bash
python generate_embeddings.py --no_visualize
```

#### არსებული ემბედინგების გადაწერა
```bash
python generate_embeddings.py --overwrite
```

#### სრული პარამეტრებით
```bash
python generate_embeddings.py \
  --segmented_dir data/segmented \
  --output_dir data/embeddings \
  --metadata data/metadata.csv \
  --model microsoft/wavlm-base-plus \
  --device cuda \
  --segment_length 5.0 \
  --segment_overlap 1.0 \
  --copy_to_split data/split
```

## შედეგების შემოწმება

ემბედინგების გენერირების შემდეგ, შეგიძლიათ შეამოწმოთ შედეგები:

1. **ემბედინგები**: `.npy` ფაილები `data/embeddings/embeddings/` დირექტორიაში
2. **ვიზუალიზაციები**: გრაფიკები `data/embeddings/visualizations/` დირექტორიაში
3. **XTTS კონფიგურაცია**: `data/embeddings/xtts_config.json` ფაილი

ვიზუალიზაციები განსაკუთრებით სასარგებლოა ემბედინგების ხარისხის შესაფასებლად:
- ერთი სპიკერის ემბედინგები უნდა იყოს დაჯგუფებული
- სხვადასხვა სპიკერების ემბედინგები უნდა იყოს გამიჯნული

## გაფრთხილებები და რჩევები

1. **მოდელის ზომა**: WavLM-large მოდელი იძლევა უკეთეს ემბედინგებს, მაგრამ საჭიროებს მეტ GPU მეხსიერებას და უფრო ნელია.
2. **GPU მეხსიერება**: დიდი მოდელებისთვის საჭიროა მინიმუმ 8GB GPU მეხსიერება.
3. **გრძელი აუდიო**: გრძელი ფაილების დასამუშავებლად შეიძლება შეცვალოთ `segment_length` და `segment_overlap` პარამეტრები.
4. **ვიზუალიზაცია**: ვიზუალიზაციები დაგეხმარებათ ემბედინგების ხარისხის შეფასებაში, მაგრამ მათი გენერირება შეიძლება იყოს ნელი.
5. **პირველი გაშვება**: WavLM მოდელის პირველი ჩატვირთვისას შეიძლება დაგჭირდეთ კარგი ინტერნეტ კავშირი.

## დამატებითი ფუნქციონალი

თუ გსურთ მხოლოდ კონკრეტული ფუნქციონალის გამოყენება, შეგიძლიათ პირდაპირ გამოიძახოთ შესაბამისი ფუნქციები Python-დან:

```python
# მხოლოდ ემბედინგების გენერირება
from voice_embedding import VoiceEmbeddingGenerator
generator = VoiceEmbeddingGenerator()
embedding = generator.generate_embedding_from_file("audio.wav")

# მხოლოდ ვიზუალიზაცია
from embedding_visualization import EmbeddingVisualizer
visualizer = EmbeddingVisualizer()
embeddings, names = visualizer.load_embeddings("embeddings_folder")
embeddings_2d = visualizer.apply_tsne(embeddings)
visualizer.visualize_embeddings(embeddings_2d, names)
```

## შემდეგი ნაბიჯები

ემბედინგების გენერირების შემდეგ, შეგიძლიათ გადახვიდეთ XTTS-v2 მოდელის ტრენინგის ეტაპზე, სადაც ეს ემბედინგები გამოიყენება ხმის იდენტობის შესასწავლად.